# .github/workflows/generate-importances.yml
name: Generate Feature Importances Chart

on:
  schedule:
    - cron: "0 6 * * *"   # daily at 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: generate-importances-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # keep token so commit/push works

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi



      - name: Generate feature importances
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          set -e
          mkdir -p charts
          if [ -f scripts/generate_importances.py ]; then
            python scripts/generate_importances.py --out charts/feature_importances.png --top 25
          elif [ -f tools/generate_importances.py ]; then
            python tools/generate_importances.py --out charts/feature_importances.png --top 25
          else
            echo "No generator script found. Skipping."
            exit 0
          fi



      - name: Commit & push changes (if any)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): update feature importances chart"
          branch: ${{ github.ref_name }}
          file_pattern: |
            charts/*.png
            charts/*.svg
            charts/*.json
            charts/*.csv
